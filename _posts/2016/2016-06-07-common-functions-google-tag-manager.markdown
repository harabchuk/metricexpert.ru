---
layout: post
title: Где разместить общие функции в Google Tag Manager
date: '2016-06-07 07:23'
---

При подключении в GTM расширенной электронной коммерции на сайте kniharnia.by
потребовалось написать много кода на javascript. Этот код находил на странице
товары, парсил описание, цену, название и передавал в Google Analytics.

Кода получилось действительно много. В некоторых тэгах он начал дублироваться.
По хорошему, функции парсинга товаров надо было подключить в виде отдельного
javascript файла, но доступа к сайту небыло, а просить разработчиков  
занимало много времени. (Как выяснилось позже, разработчики очень быстро помогали,
  и зря я не попросил их, но зато это позволило найти способ хранения общих фукнкций)

### Как хранить общие функции в GTM

Я создал отдельный тэг с javascript и в нем добавил глобальный массив с функциями.
Можно было и просто написать функции, но не хотел замусоривать глобальное пространство имен.
Переменную с функциями я назвал kn_common от слова kniharnia, имя конечно, может быть любым.

```html
<script>
window.kn_common = {

    // get the product info (title, price, desc)
    get_product: function(){
        return {
          ...
        };
    },

    // get current category
    get_category: function(){
        return '...';
    }

};
</script>
```

Важно, чтобы тэг с общими функциями запускался раньше других тэгов. Поскольку
весь мой код срабатывал после тэга Google Analytics, я назначил запуск тэга с общими
функциями перед Google Analytics.

### Использование общих функций

Теперь в любом тэге, у меня доступен массив функцйи kn_common, например, в тэге
срабатыающем по клику на товар.

```html
<script>
  var payload = {
      category: kn_common.get_category()
      ...
  }
  ...
  ...
</script>
```
